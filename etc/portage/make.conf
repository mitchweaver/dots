#=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/
#
#     .vir.                                d$b
#  .d$$$$$$b.    .cd$$b.     .d$$b.   d$$$$$$$$$$$b  .d$$b.      .d$$b.
#  $$$$( )$$$b d$$$()$$$.   d$$$$$$$b Q$$$$$$$P$$$P.$$$$$$$b.  .$$$$$$$b.
#  Q$$$$$$$$$$B$$$$$$$$P"  d$$$PQ$$$$b.   $$$$.   .$$$P' `$$$ .$$$P' `$$$
#    "$$$$$$$P Q$$$$$$$b  d$$$P   Q$$$$b  $$$$b   $$$$b..d$$$ $$$$b..d$$$
#   d$$$$$$P"   "$$$$$$$$ Q$$$     Q$$$$  $$$$$   `Q$$$$$$$P  `Q$$$$$$$P
#  $$$$$$$P       `"""""   ""        ""   Q$$$P     "Q$$$P"     "Q$$$P"
#  `Q$$P"                                  """
#
# $ /etc/portage/make.conf
#
# https://github.com/mitchweaver/dots
#
#=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/=/

# ******************************************************
# ---------- PORTAGE SETTINGS --------------------------
# ******************************************************
EMERGE_DEFAULT_OPTS="--ask --ask-enter-invalid --verbose"
FEATURES="compress-build-logs parallel-fetch ccache nodoc noinfo network-sandbox ipc-sandbox -news -loadpolicy"
CCACHE_DIR=/var/cache/ccache
CCACHE_CONFIGPATH=/etc/portage/ccache.conf
CCACHE_UMASK="0002"
GRUB_PLATFORMS="efi-64"
ACCEPT_LICENSE="-* @FREE @BINARY-REDISTRIBUTABLE"
ACCEPT_KEYWORDS="~amd64"
L10N="en"
PORTDIR=/var/db/repos/gentoo
DISTDIR=/var/cache/distfiles
PKGDIR=/var/cache/binpkgs
LC_MESSAGES=C

################### set portage to lowest nice level as not to bog down system
##################PORTAGE_NICENESS="19"
##################PORTAGE_IONICE_COMMAND="ionice -c 3 -p \${PID}"

# ******************************************************
# ----------- COMPILER FLAGS ---------------------------
# ******************************************************
COMMON_FLAGS_PERFORMANCE="-O3 -pipe -fno-math-errno -fasynchronous-unwind-tables"
COMMON_FLAGS_HARDENING=""

# Explicitly forbid execution on the stack.
# see: http://linux.die.net/man/8/execstack
COMMON_FLAGS_HARDENING="$COMMON_FLAGS_HARDENING -Wl,-z,noexecstack"

# Add stack canaries to functions.
#
# * protector: add to functions gcc believes to be vulnerable
# * protector-strong: add to all functions with arrays larger than 4 bytes
# * protector-all: add to ALL functions, regardless of arrays
#
# note: 'all' is generally considered a waste.
# see: http://wiki.osdev.org/Stack_Smashing_Protector
COMMON_FLAGS_HARDENING="$COMMON_FLAGS_HARDENING -fstack-protector-strong"

# Prevent stack clash attacks.
# see: http://gcc.gnu.org/onlinedocs/gcc/Instrumentation-Options.html
COMMON_FLAGS_HARDENING="$COMMON_FLAGS_HARDENING -fstack-clash-protection"

# Check that target addresses are valid before changing flow control.
# Helps protect against ROP attacks.
#
# * branch: only branching
# * return: only returns
# * full: both
#
# see: http://gcc.gnu.org/onlinedocs/gcc/Instrumentation-Options.html
COMMON_FLAGS_HARDENING="$COMMON_FLAGS_HARDENING -fcf-protection=full"

# Full Read-Only Relocation
#
# * disable lazy library binding
# * makes shared libraries read-only after ASLR relocation
# * '-z,now', ("full" RELRO), marks entire Global Offset Table as read-only
# * prevents an attacker from gaining execution control through the GOT
#
# see: http://redhat.com/en/blog/hardening-elf-binaries-using-relocation-read-only-relro
# see: http://tk-blog.blogspot.com/2009/02/relro-not-so-well-known-memory.html
COMMON_FLAGS_HARDENING="$COMMON_FLAGS_HARDENING -Wl,-z,relro,-z,now"

# Reject undefined symbols at link time and forbid underlinking.
# Many attacks rely on taking control of these undefined symbols.
#
# This also allows you to see errors during the build
# rather than pushing a bug to occur at run time.
#
# see: http://bugzilla.mozilla.org/show_bug.cgi?id=333640
# see: http://wiki.rosalab.ru/ru/index.php/Underlinking#Why_underlinking_is_bad
COMMON_FLAGS_HARDENING="$COMMON_FLAGS_HARDENING -Wl,-z,defs"

# Enable buffer overflow checks.
# see: http://access.redhat.com/blogs/766093/posts/1976213
COMMON_FLAGS_HARDENING="$COMMON_FLAGS_HARDENING -D_FORTIFY_SOURCE=2"

# Enable bounds checking for strings as well as null pointer checks.
# see: http://gcc.gnu.org/onlinedocs/libstdc++/manual/using_macros.html
COMMON_FLAGS_HARDENING="$COMMON_FLAGS_HARDENING -D_GLIBCXX_ASSERTIONS"

# Error on exceeding of array boundaries
#COMMON_FLAGS_HARDENING="$COMMON_FLAGS_HARDENING -Werror=array-bounds"

COMMON_FLAGS="$COMMON_FLAGS_PERFORMANCE $COMMON_FLAGS_HARDENING"
CFLAGS="${COMMON_FLAGS} $CFLAGS"
CPPFLAGS="${COMMON_FLAGS} $CPPFLAGS"
CXXFLAGS="${COMMON_FLAGS} $CXXFLAGS"
FCFLAGS="${COMMON_FLAGS} $FCFLAGS"
FFLAGS="${COMMON_FLAGS} $FFLAGS"

# ******************************************************
# ----------- MACHINE SPECIFIC -------------------------
# ******************************************************
# thinkpad x1 carbon 7th gen --- i5-8350u
MAKEOPTS="-j8 -l9"
CPU_USE_FLAGS="aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt rdrand sse sse2 sse3 sse4_1 sse4_2 ssse3"
VIDEO_CARDS="intel i915"
INPUT_DEVICES="libinput"
# DESKTOP ---- i7-12700k
####CPU_USE_FLAGS="?"
####VIDEO_CARDS="nouveau"
####INPUT_DEVICES="libinput joystick"

# ******************************************************
# -------------- USE FLAGS -----------------------------
# ******************************************************
USE="\
# ======================================================
# Positive Use Flags
# ======================================================
# USE_DESKTOP
bluetooth alsa pipewire xinerama man \
# USE_HARDENING
hardened cet seccomp caps filecaps crypt \
# USE_OSS_ALTERNATIVES
openmp openipmi \
# USE_GENTOO_SPECIFIC
branding \
# ======================================================
# Negative Use Flags
# ======================================================
# SYSTEMD
-systemd -networkmanager -resolvconf -polkit -policykit \
# JUNK
-nls -bindist -cjk -profile \
# DOCUMENTATION
-doc -gtk-doc -docs -handbook -examples -extras -test \
# KDE
-kde -kwallet -plasma -telepathy -semantic-desktop -webengine \
# GNOME
-gnome -gnome-online-accounts -gnome-keyring \
# PRIVACY
-geoip -geoloc -telemetry -exif \
# OBSOLETE_HARDWARE
-dvd -dvdr -vcd -dv -cdda -cdinstall -cdr -bluray -a52 -css \
# OBSOLETE_LANGUAGE
-fortran -ada -ocaml -java -oracle -ibm \
# HARDWARE_DONT_CARE
-scanner -joystick -smartcard \
# APPLE
-ipod -ios -ieee1394 -dc1394 -aqua -quicktime -xine -coreaudio \
# PROTOCOLS
-kerberos -ldap -zeroconf -gstreamer -nntp -ipv6 \
# ACCESSIBILITY
-accessibility -sox -speex -speech \
# SHELLS
-bash-completion -zsh-completion -fish-completion \
# EMACS
-emacs -xemacs \
# DEBUG
-valgrind -unwind \
# WAYLAND
-wayland \
# PROPRIETARY
-nvenc \
# JUNK
-startup-notification -appindicator \
# MISC
-cracklib -screencast -sendmail -lastfm -nas -berkdb -oci8 -firebird -afs -emboss -oniguruma -calendar \
"
